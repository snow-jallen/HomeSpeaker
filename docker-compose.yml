version: '3.4'
services:
  homespeaker.server2:
    container_name: homespeaker
    image: homespeakerserver2
    build:
      context: .
      dockerfile: HomeSpeaker.Server2/Dockerfile
    restart: unless-stopped
    devices:
    - /dev/snd:/dev/snd
    ports:
    - 80:80
    - 443:443
    volumes:
    - "/home/piuser/music:/music"
    - "/home/piuser/cert:/certs"
    - "/sys/class/backlight/10-0045:/sys/class/backlight/10-0045"
    - airplay-shared:/tmp/airplay-shared  # Shared volume for AirPlay state
    - /run/user/1000/pulse:/run/user/1000/pulse:rw
    depends_on:
    - aspire    
    environment:
    - MediaFolder=/music
    - ALSA_CARD=Headphones
    - SqliteConnectionString=Data Source=/music/HomeSpeaker.db
    - ASPNETCORE_URLS=https://+443;http://+:80
    - ASPNETCORE_Kestrel__Certificates__Default__Path=/certs/certificate.pfx
    - FFMpegLocation=/usr/bin/ffmpeg
    - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
    - OTEL_EXPORTER_OTLP_ENDPOINT=http://aspire:18889
    - OTEL_SERVICE_NAME=HomeSpeaker
    - NIGHTSCOUT_URL=https://janedoe.azurewebsites.net
    - Temperature__ApiKey=${GOVEE_API_KEY}
    - PULSE_SERVER=unix:/run/user/1000/pulse/native
    networks:
      speakernet:

  aspire:
    container_name: aspire
    image: mcr.microsoft.com/dotnet/aspire-dashboard:9.0
    environment:
    - DOTNET_DASHBOARD_UNSECURED_ALLOW_ANONYMOUS=true
    ports:
    - 18888:18888 # web
    - 4317:18889  # OTLP
    networks:
      speakernet:

  airplay-receiver:
    image: mikebrady/shairport-sync:latest
    container_name: homespeaker-airplay
    restart: unless-stopped
    network_mode: host
    hostname: kitchen-homespeaker  # Set a specific hostname for this container
    devices:
      - /dev/snd:/dev/snd  # Add direct ALSA device access
    volumes:
      - ./shairport-sync.conf:/tmp/shairport-sync-template.conf:ro
      - airplay-shared:/tmp/airplay-shared  # Shared volume for state files
      - /run/user/1000/pulse:/run/user/1000/pulse:rw  # PulseAudio socket
    environment:
      - PULSE_SERVER=unix:/run/user/1000/pulse/native
      - PULSE_RUNTIME_PATH=/run/user/1000/pulse
      - AIRPLAY_NAME=${AIRPLAY_NAME:-HomeSpeaker}
    entrypoint: ["/bin/sh"]
    command: 
      - -c
      - |
        set -e
        echo "=== Bypassing s6 init and starting manually ==="
        echo "Using AirPlay name: $${AIRPLAY_NAME}"
        echo "Hostname: $(hostname)"
        
        # Kill any existing s6 processes to ensure clean start
        pkill -f s6 || true
        
        # Copy template and replace placeholder with actual name
        cp /tmp/shairport-sync-template.conf /etc/shairport-sync.conf
        sed -i "s/AIRPLAY_NAME_PLACEHOLDER/$${AIRPLAY_NAME}/g" /etc/shairport-sync.conf
        
        echo "=== Config file generated ==="
        cat /etc/shairport-sync.conf
        
        echo ""
        echo "=== Starting required services manually ==="
        
        # Start D-Bus system daemon
        echo "Starting D-Bus..."
        mkdir -p /var/run/dbus
        dbus-daemon --system --fork --print-pid > /var/run/dbus.pid || true
        sleep 2
        
        # Start Avahi daemon for mDNS
        echo "Starting Avahi daemon..."
        avahi-daemon --daemonize --no-drop-root || true
        sleep 3
        
        echo ""
        echo "=== Audio setup debugging ==="
        echo "PULSE_SERVER: $${PULSE_SERVER}"
        echo "PULSE_RUNTIME_PATH: $${PULSE_RUNTIME_PATH}"
        ls -la /run/user/1000/pulse/ || echo "PulseAudio socket not found"
        
        # Test PulseAudio connection
        which pactl && pactl info || echo "PulseAudio not accessible, will fall back to ALSA"
        
        echo ""
        echo "=== Starting shairport-sync ==="
        exec /usr/local/bin/shairport-sync -c /etc/shairport-sync.conf -v
    depends_on:
      - homespeaker.server2

networks:
 speakernet:

volumes:
  airplay-shared:
